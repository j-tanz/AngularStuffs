Lesson Plan: 9.4

Open the [slidedeck](https://docs.google.com/presentation/d/1qD04N644b3EPwPBAB2_vTPxMG_8c-YhR0Cclymef4k4/edit?usp=sharing) for this lesson.

File(s): `02-activities/`

## Reactive Form Basics (70 minutes)

### Instructor Do: The Why ( 5 min )

* Angular has 2 main ways to handle user form input: Template-driven forms and Reactive Forms. Both are perfectly valid, although each have trade-offs.

* Template-Driven forms, by nature, are primarily driven by the HTML file (the template). However, due to being HTML rather than in TypeScript, testing is much more difficult.

* Reactive Forms are driven by a data model, and thus the logic of form creation is primarily in the TypeScript file and less so in the HTML file.

* With the form being driven by a data model, Reactive Forms are inherently easier to test and debug (for example, it can be tricky to grab a value drive by a template, but TypeScript code can easily be paused with a breakpoint in Chrome DevTools and you can observe the Reactive Form Controls.

Reactive Forms Docs: https://angular.io/guide/reactive-forms

#### Instructor Do: Demo Application ( 5 mins )

File(s): `02-activities/to-do-list`

* Demo To-Do list app with Reactive Forms, without MomentJS.

* Main task: Generate the AddTaskComponent, inject the TasksService and FormBuilder, set up Reactive Form, and set up buttons/methods to CRUD tasks via the TasksService.

### Students Do: Generate Add-Task Component, inject TasksService ( 10 mins )

File(s): `02-activities/01-stu_addtask_component/README.md`

Instructions:

* `ng generate component AddTask` (Angular will translate this to `<app-add-task>` as AddTaskComponent)

* Can also: `ng g c AddTask`

* Place `<app-add-task></app-add-task>` in AppComponent

* Inject TasksService with DI: `constructor(private tasksService: TasksService)`

### Instructor Review: Generate Add-Task Component, inject TasksService ( 5 mins )

File(s): `02-activities/01-stu_addtask_component/solved`

### Instructor Do: Create First Reactive Form ( 15 mins )

File(s): `02-activities/02-reactive_form`

* Import `ReactiveFormsModule` into AppModule

```ts
// app.module.ts

import { FormsModule, ReactiveFormsModule } from '@angular/forms';

  imports: [
    BrowserModule,
    AppRoutingModule,
    FormsModule,
    ReactiveFormsModule
```

* Inject `private fb: FormBuilder` into the constructor of the add-task component.

```ts
// add-task.component.ts

  constructor(
    private fb: FormBuilder,
    private tasksService: TasksService
    ) { }

```

* Note and very helpful: For easy imports in VS Code, place cursor over red underlined text of non-imported item, and select `Quick Fix`.

* Explain that we're going to use the `FormBuilder` service; there **are** other ways to create Reactive Form controls without it, but we'll skip those for now; the `FormBuilder` simplifies the form creation process.

* Create a `taskForm` property. This will be the form used for the app:

```typescript
// 

taskForm = this.fb.group({
    title: [''],
    detailText: ['']
})
```

* This creates two Form Controls.

* What is a Form Control? A single piece of the form that tracks value and validation. [Angular Docs Link](https://angular.io/api/forms/FormControl)

* Save and demonstrate: Add a breakpoint and/or `console.log('taskForm', this.taskForm)` in `ngOnInit`. Walk through every property of the form that has been generated by the `FormBuilder`:

    * Key ones to know: `controls` and `value`

    * `controls` contains the individual `FormControl` classes; note that these have many similar properties as the larger `FormGroup`

    * The others are primarily info-related, such as `status`, `errors`, `pristine`, etc.

* Hook the form up to the template HTML:

    * Create some basic Bootstrap grid structure in the `AddTask` component.

    * Add a `<form></form>` initially

    * To hook it to the `taskForm`, add `[formGroup]="taskForm"` onto the `<form>`. Emphasize the `[property]` binding with square brackets

    * Add the first `<input>`. Then to bind it to the form, adjust to be `<input formControlName="title">`

        **Note: `formControlName` is used **when the HTML tag is already inside of a `<form [formGroup]=""></form>`**

* Add a submit button below it: 

```html
<button type="submit">Add Task</button>
```

* To submit: add to the form to be: 

```html
<form [formGroup]="taskForm" (ngSubmit)="onSubmit()">
```

`onSubmit` is triggered by any `<button>` in the `<form>` that is `type="submit"` **OR** not `type=""` specified. 

**This is important to emphasize, where if you have a button anywhere in the form and don't specify `type="button"`, then HTML will assume that it is `type="submit"` and submit the form when pressed.**

* Lastly, add the `onSubmit()` method. Just have it `console.log('taskForm', this.taskForm)` for now and in the console, show how the `taskForm` has the text you entered in the `<input>` field.

### Partners Do: Create First Reactive Form ( min )

File(s): `02-activities/03-stu_reactive_form/README.md`

Instructions:

In the same way that was shown in class, go through the motions of creating a reactive form.

1. Import `ReactiveFormsModule` into AppModule
1. Inject `private fb: FormBuilder` into the constructor of the add-task component.
1. Create a `taskForm` property.
1. Create a form element with an input. Remember to hook this form into `taskForm` by adding [formGroup]="taskForm".
1. Add a submit button and remember to add [ngSubmit]="onSubmit()". Remember, we haven't created the `onSubmit` method yet!


* Ensure that the form submits and logs the form when submitted

### Instructor Review: Create First Reactive Form ( min )

File(s): `02-activities/03-stu_reactive_form/solved`

* Call on students to review what we just did

* Give quick recap

* Field questions

---

### Break ( 5 mins )

---

## Reactive Form: Submitting and Updating (45 minutes)

### Instructor Do: Submitting Forms ( 5 min )

File(s): `02-activities/04-inst_submit`

* Briefly review how `(ngSubmit)` works

* Now we're going to have a form submission actually add a task!

* Add the below submit method into add-task.component.ts:

```typescript
// add-task.component.ts

  onSubmit() {
    const title = this.taskForm.value.title;
    this.tasksService.addTask(title, false)
  }
```

* Discuss how the `taskForm.value` property contains the values of the form controls. You could also access `taskForm.controls.title.value` to get the value directly from the control.

### Students Do: Have Form Submission add a Task ( 10 min )

File(s): `02-activities/05-stu_submit/README.md`

Instructions:

Inside of `add-task.component.ts`, create the `onSubmit()` method that we created in class.

### Instructor Review: Have Form Submission add a Task  ( 5 min )

File(s): `02-activities/05-stu_submit/solved`

### Instructor Do: Updating Forms ( 10 min )

File(s): `02-activities/06-inst_update`

* Add a second `<input>` for the `detailText` property and bind to the `detailText` FormControl

* Demonstrate how our form will take 2 inputs now via 2 controls

* Add two buttons: A patchValue one and setValue one

* Create methods for the two buttons:

```typescript
onPatchSampleText() {
    // you could also patch title: "text" onto this Object, but the intent with these functions is to show that setValue overwrites, while patchvalue just updates the form
    this.taskForm.patchValue({
      detailText: "Sample detail text!\nHere's a new line."
    })
  }

  onSetSampleText() {
    // you could also patch title: "text" onto this Object, but the intent with these functions is to show that setValue must take in *all* of the form controls to overwrite the whole form.
    this.taskForm.setValue({
      title: "New setValue() title",
      detailText: "Sample .setValue() text! Notice that setValue() overwrites the whole form, requiring every FormControl to be set to a value."
    })
  }
  ```

  * Use the two to demonstrate how setValue sets *all* values for a form (all must be inputted), while `patchValue` can just patch single values. `patchValue` will likely be used much more than `setValue` for this reason.


### Students Do: Add sample setValue and patchValue Buttons ( 10 min )

File(s): `02-activities/07-stu_update/README.md`

Instructions:

1. Add a second `<input>` for the `detailText` property and bind to the `detailText` FormControl
1. Add two buttons: A patchValue one and setValue one
1. Create the two methods for the two buttons as shown in class

### Instructor Review: Add sample setValue and patchValue Buttons ( 5 min )

File(s): `02-activities/07-stu_update/solved`

### Instructor Do: Form Reset Button ( 5 min )

File(s): `02-activities/08-inst_reset`

* Add a reset button. Bind it to a reset function:

```typescript

  onResetForm() {
    this.taskForm.reset();
  }
```

  * Demonstrate how it clears any inputted values

### Students Do: Add Reset button ( 5 min )

File(s): `02-activities/09-stu_reset/README.md`

Instructions:

1. Add reset button to the HTML and make it call the method, `onReset()`
1. Create the `onReset()` method and have it `reset()` the taskForm.

### Instructor Do: Quick Review ( 2 min )

File(s): `02-activities/09-stu_reset/solved`

---

### Lunch ( 45 min)

---

## Validation I (45 minutes)

### Instructor Do: Discuss and Demonstrate Validators ( 15 min )

File(s): `02-activities/10-inst_validation`

* Reactive Forms have many built-in validators.

* Add a required and minLength validator:

```typescript
// add-task.component.ts

import { FormBuilder, Validators } from '@angular/forms';

  taskForm = this.fb.group({
    title: ['', [Validators.required, Validators.minLength(4)]],
    detailText: ['']
  })
```

* The reason the properties in `fb.group` arguments are arrays are because 2nd arguments is a validator (or array of validators, as shown above)

* Send out the [Validator docs link](https://angular.io/api/forms/Validators)

* Add a few references to form statuses below the form:

```html
          <h5>Form Info</h5> <br>
          <p>Status: {{taskForm.status}}<br>
            Pristine: {{taskForm.pristine}}<br>
            Dirty: {{taskForm.dirty}}<br>
            Touched: {{taskForm.touched}}<br>
            Errors: {{taskForm.errors}}<br>
          </p>
```

* With the validators now, notice how the form status will be `INVALID` until the title is filled in and has a length >= 4

* Explain pristine, dirty, and touched

### Students Do: Validators( 25 min )

File(s): `02-activities/11-stu_validator/README.md`

Instructions:

* Add the status texts below the form

* Add the 2 validators shown in class (required and minimum length of 4)

* Add 1-2 extra validators that were *not* demonstrated in class.

### Instructor Do: Review ( 5 min )

File(s): `02-activities/11-stu_validator/solved`

* Briefly discuss custom validators and [send out Angular docs link for reference](https://angular.io/guide/form-validation#custom-validators)

---

### Break ( 5 mins )

---

## Value Change (45 minutes)

### Instructor Do: `valueChanges` + Basic Observable ( 15 min )

File(s): `02-activities/12-inst_value_change`

* Explain a few use cases where we may want to run code *anytime* something on the form is changed

* Introduce `valueChanges`: An observable that emits a new value everytime a value on the form changes

* Good spot to briefly touch on Observables, best done with the example. Add to `ngOnInit`:

```typescript
// add-task.component.ts
import { Subscription } from 'rxjs';

  valueChangeSub: Subscription;

  ngOnInit() {
    // set up an observable to log value changes
    this.valueChangeSub = this.taskForm.valueChanges.subscribe(
      (res: any) => {
        console.log('Form', this.taskForm);
        console.log('Form Value Changed', res);

      },
      err => { console.error(err); },
      () => { }
    );
  }
```

* Observables asynchronously can emit 3 different events: a value, an error, or a completion

* Describe how the `.subscribe()` code works and its 3 arguments (value, error, complete).

    * Observables are similar to promises, except that an Observable is a *stream*. Sometimes only one value is emitted (as in with a promise), but they have far more capabilities than promises

* Demonstrate how the console.logs are fired when the value on the form is changed

### Students Do: Value Change( 5 min )

File(s): `02-activities/13-stu_value_change/README.md`

Instructions:

* Add the value changes code shown in class and experiment!

### Instructor Review: Value Change ( 5 min )

File(s): `02-activities/13-stu_value_change/solved`

### Instructor Discuss: Observables Require Unsubscribe ( 15 min )

File(s): `02-activities/14-inst_unsubscribe`

* Important: Probably the only main area to watch for memory leaks in Angular

* Once an observable is subscribed to, the subscription still exists *even after the component is destroyed*

* Cleanup is required, so add `ngOnDestroy() {}` to the `AddTaskComponent` and have the class `implements OnDestroy`. Import `OnDestroy` quickly via hovering over `OnDestory` and selecting Quick fix.

* Add a `valueChangeSub` property to the component

* Change the valuesChanges line to be: `this.valueChangeSub = this.taskForm.valueChanges.subscribe(...`

* Add to `ngOnDestroy()`:

```typescript
import { Component, OnInit, OnDestroy } from '@angular/core';

export class AddTaskComponent implements OnInit, OnDestroy { }

ngOnDestroy(): void {
  if (this.valueChangeSub) {
    this.valueChangeSub.unsubscribe();
  }
}
```

* In this code, we first check for whether the subscription exists, then unsubscribe if so

* Because an Observable is a *stream*, we can manipulate the stream with a pipe. There are *many* RxJS/ReactiveX (the library for Observables) operators, but the `first()` operator just takes the first value and unsubscribes.

* `first()` will cover many use cases in Angular where only one value is requested from the Observable (such as HTTP requests)

* [RxJS docs for unsubscribe](https://www.learnrxjs.io/operators/filtering/first.html)

### Partner Do: Observables Require Unsubscribe ( 10 min )

File(s): `02-activities/15-stu_unsubscribe/README.md`

Instructions:

* Add the method shown in class to unsubscribe from `valueChanges`

### Instructor Review: Observables Require Unsubscribe ( 5 min )

File(s): `02-activities/15-stu_unsubscribe/solved`

---

Â© 2019 Trilogy Education Services

[i_do]: https://github.com/coding-boot-camp/Java-6-module/blob/master/id_resources/icons/i_do/res/mipmap-hdpi/i_do.png "Instructor do"


[we_do]: https://github.com/coding-boot-camp/Java-6-module/blob/master/id_resources/icons/we_do/res/mipmap-hdpi/we_do.png "We Do"


[you_do]: https://github.com/coding-boot-camp/Java-6-module/blob/master/id_resources/icons/you_do/res/mipmap-hdpi/you_do.png "Student Do"


[assess]: https://github.com/coding-boot-camp/Java-6-module/blob/master/id_resources/icons/assess/res/mipmap-hdpi/assess.png "Assessment"


[break]: https://github.com/coding-boot-camp/Java-6-module/blob/master/id_resources/icons/break/res/mipmap-hdpi/break.png "Break"


[warn]: https://github.com/coding-boot-camp/Java-6-module/blob/master/id_resources/icons/warn/res/mipmap-hdpi/warn.png "Warning"